name: Reusable Secrets Scanning

on:
  workflow_call:
    inputs:
      scan_path:
        description: 'Path to scan for secrets'
        required: false
        type: string
        default: '.'
      fail_on_detection:
        description: 'Fail workflow if secrets are detected'
        required: false
        type: boolean
        default: true
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  secrets-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install GitLeaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          gitleaks version
      
      - name: Scan for Secrets
        id: gitleaks
        run: |
          echo "üîç Scanning for secrets in: ${{ inputs.scan_path }}"
          
          # Run gitleaks
          if gitleaks detect --source="${{ inputs.scan_path }}" --report-format json --report-path gitleaks-report.json --no-git; then
            echo "‚úÖ No secrets detected"
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Secrets potentially detected"
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            
            if [ -f gitleaks-report.json ]; then
              echo "üìã Gitleaks Report:"
              cat gitleaks-report.json | jq -r '.[] | "- \(.File):\(.StartLine) - \(.Description)"' || cat gitleaks-report.json
            fi
          fi
        continue-on-error: true
      
      - name: Upload Secrets Scan Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-report
          path: gitleaks-report.json
          retention-days: 30
        continue-on-error: true
      
      - name: Evaluate Results
        if: steps.gitleaks.outputs.secrets_found == 'true' && inputs.fail_on_detection
        run: |
          echo "‚ùå Secrets detected in the repository!"
          echo "Please review the gitleaks-report.json artifact for details."
          echo "Remove any exposed secrets and rotate them immediately."
          exit 1
      
      - name: Success Summary
        if: steps.gitleaks.outputs.secrets_found == 'false'
        run: |
          echo "‚úÖ Secrets scan completed successfully"
          echo "No secrets detected in the codebase"
