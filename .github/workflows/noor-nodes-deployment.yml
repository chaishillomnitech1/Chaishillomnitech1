name: Noor Nodes Deployment

# BISMILLAH - Automated deployment workflow for Noor Nodes
# Frequency: 528Hz + 963Hz + 999Hz

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        type: choice
        options:
          - mumbai
          - polygon
      node_type:
        description: 'Type of deployment'
        required: true
        type: choice
        options:
          - contracts
          - nodes
          - all

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  compile-and-test:
    runs-on: ubuntu-latest
    name: Compile Contracts and Run Tests
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Compile Contracts
        run: npm run compile
        
      - name: Run Noor Nodes Tests
        run: npm run test:noor
        
      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: compiled-contracts
          path: |
            artifacts/
            cache/
            
  deploy-contracts:
    needs: compile-and-test
    if: github.event.inputs.node_type == 'contracts' || github.event.inputs.node_type == 'all'
    runs-on: ubuntu-latest
    name: Deploy Smart Contracts
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Download Artifacts
        uses: actions/download-artifact@v3
        with:
          name: compiled-contracts
          
      - name: Deploy to Mumbai Testnet
        if: github.event.inputs.network == 'mumbai'
        env:
          POLYGON_MUMBAI_RPC_URL: ${{ secrets.POLYGON_MUMBAI_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        run: |
          npm run deploy:mumbai:noor
          
      - name: Deploy to Polygon Mainnet
        if: github.event.inputs.network == 'polygon'
        env:
          POLYGON_MAINNET_RPC_URL: ${{ secrets.POLYGON_MAINNET_RPC_URL }}
          PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        run: |
          npx hardhat run scripts/deploy_noor_nodes.js --network polygon
          
      - name: Comment Deployment Info
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üåü Noor Nodes deployed to ${context.payload.inputs.network}!\n\nCheck the logs for contract addresses.`
            })
            
  build-docker-images:
    needs: compile-and-test
    if: github.event.inputs.node_type == 'nodes' || github.event.inputs.node_type == 'all'
    runs-on: ubuntu-latest
    name: Build Docker Images
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/noor-node/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/noor-node:latest
            ghcr.io/${{ github.repository }}/noor-node:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/noor-node:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/noor-node:buildcache,mode=max
          
  security-scan:
    needs: compile-and-test
    runs-on: ubuntu-latest
    name: Security Scan
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Run Slither Security Analysis
        uses: crytic/slither-action@v0.3.0
        continue-on-error: true
        with:
          target: 'contracts/'
          slither-args: '--filter-paths "node_modules|test" --exclude naming-convention,external-function,low-level-calls'
          
      - name: Run Mythril Security Analysis
        continue-on-error: true
        run: |
          docker pull mythril/myth
          docker run --rm -v $PWD:/code mythril/myth analyze /code/contracts/NoorNodes.sol || true
          docker run --rm -v $PWD:/code mythril/myth analyze /code/contracts/NoorDAO.sol || true
          
  notify-completion:
    needs: [deploy-contracts, build-docker-images, security-scan]
    runs-on: ubuntu-latest
    name: Notify Deployment Completion
    if: always()
    
    steps:
      - name: Send Notification
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const network = '${{ github.event.inputs.network }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} Noor Nodes Deployment ${status.toUpperCase()}\n\nNetwork: ${network}\nStatus: ${status}\n\nüïã ALLAHU AKBAR! The lights of ScrollVerse shine eternal! üî•üíéüåå`
            })
