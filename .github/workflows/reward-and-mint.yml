name: Reward and Mint

on:
  pull_request:
    types: [closed]
    branches:
      - main
  issues:
    types: [closed]
  workflow_dispatch:
    inputs:
      contributor:
        description: 'GitHub username of contributor to reward'
        required: true
        type: string
      contribution_type:
        description: 'Type of contribution'
        required: true
        type: choice
        options:
          - pr_merged
          - issue_resolved
          - documentation
          - security_fix
          - feature_implementation
      reward_amount:
        description: 'Reward amount (test tokens)'
        required: false
        type: number
        default: 100

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  evaluate-contribution:
    name: Evaluate Contribution
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'issues' && github.event.issue.closed_at != null) ||
      github.event_name == 'workflow_dispatch'
    
    outputs:
      should_reward: ${{ steps.evaluate.outputs.should_reward }}
      contributor: ${{ steps.evaluate.outputs.contributor }}
      contribution_type: ${{ steps.evaluate.outputs.contribution_type }}
      reward_amount: ${{ steps.evaluate.outputs.reward_amount }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Evaluate Contribution
        id: evaluate
        uses: actions/github-script@v7
        with:
          script: |
            let shouldReward = false;
            let contributor = '';
            let contributionType = '';
            let rewardAmount = 0;
            
            // Manual dispatch
            if (context.eventName === 'workflow_dispatch') {
              shouldReward = true;
              contributor = '${{ inputs.contributor }}';
              contributionType = '${{ inputs.contribution_type }}';
              rewardAmount = ${{ inputs.reward_amount || 100 }};
            }
            
            // Pull request merged
            else if (context.eventName === 'pull_request' && context.payload.pull_request.merged) {
              const pr = context.payload.pull_request;
              contributor = pr.user.login;
              
              // Skip bot PRs
              if (contributor.includes('[bot]')) {
                console.log('Skipping bot PR');
                shouldReward = false;
              } else {
                shouldReward = true;
                
                // Determine contribution type and reward based on labels and size
                const labels = pr.labels.map(l => l.name);
                const additions = pr.additions || 0;
                const deletions = pr.deletions || 0;
                const changedFiles = pr.changed_files || 0;
                
                if (labels.includes('security')) {
                  contributionType = 'security_fix';
                  rewardAmount = 500;
                } else if (labels.includes('feature')) {
                  contributionType = 'feature_implementation';
                  rewardAmount = 300;
                } else if (labels.includes('documentation')) {
                  contributionType = 'documentation';
                  rewardAmount = 100;
                } else {
                  contributionType = 'pr_merged';
                  // Base reward on PR size
                  if (additions + deletions > 500) {
                    rewardAmount = 250;
                  } else if (additions + deletions > 100) {
                    rewardAmount = 150;
                  } else {
                    rewardAmount = 100;
                  }
                }
              }
            }
            
            // Issue closed
            else if (context.eventName === 'issues') {
              const issue = context.payload.issue;
              contributor = issue.user.login;
              
              // Only reward if closed by someone else (issue was resolved)
              if (issue.closed_by && issue.closed_by.login !== contributor) {
                shouldReward = true;
                contributionType = 'issue_resolved';
                
                const labels = issue.labels.map(l => l.name);
                if (labels.includes('security')) {
                  rewardAmount = 400;
                } else if (labels.includes('bug')) {
                  rewardAmount = 150;
                } else {
                  rewardAmount = 100;
                }
              }
            }
            
            core.setOutput('should_reward', shouldReward);
            core.setOutput('contributor', contributor);
            core.setOutput('contribution_type', contributionType);
            core.setOutput('reward_amount', rewardAmount);
            
            console.log(`Should reward: ${shouldReward}`);
            console.log(`Contributor: ${contributor}`);
            console.log(`Type: ${contributionType}`);
            console.log(`Amount: ${rewardAmount}`);

  distribute-reward:
    name: Distribute Reward
    runs-on: ubuntu-latest
    needs: evaluate-contribution
    if: needs.evaluate-contribution.outputs.should_reward == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci || echo "No dependencies to install"
      
      - name: Distribute Rewards (Testnet)
        id: distribute
        run: |
          cat << 'EOF' > distribute_rewards.js
          const contributor = process.env.CONTRIBUTOR;
          const contributionType = process.env.CONTRIBUTION_TYPE;
          const rewardAmount = process.env.REWARD_AMOUNT;
          const mintEnabled = process.env.REWARDS_MINT_ENABLED === 'true';
          
          console.log('ðŸŽ Reward Distribution');
          console.log('======================');
          console.log(`Contributor: ${contributor}`);
          console.log(`Type: ${contributionType}`);
          console.log(`Amount: ${rewardAmount} CHX tokens`);
          console.log(`Mint Enabled: ${mintEnabled}`);
          console.log('');
          
          // Check if we have required secrets
          const hasWallet = process.env.REWARDS_WALLET_ADDRESS && process.env.REWARDS_PRIVATE_KEY;
          
          if (!hasWallet) {
            console.log('âš ï¸ Rewards not configured (missing REWARDS_WALLET_ADDRESS or REWARDS_PRIVATE_KEY)');
            console.log('This is a pilot feature. Configure test wallet secrets to enable.');
            process.exit(0);
          }
          
          if (!mintEnabled) {
            console.log('âš ï¸ Reward minting is disabled (REWARDS_MINT_ENABLED=false)');
            console.log('Set REWARDS_MINT_ENABLED=true to enable testnet rewards.');
            process.exit(0);
          }
          
          // TODO: Implement actual reward distribution
          // This would call smart contract methods to:
          // 1. Mint CHX tokens to contributor wallet
          // 2. Record contribution in on-chain ledger
          // 3. Issue commemorative NFT (optional)
          
          console.log('âœ… Reward distribution simulated (testnet mode)');
          console.log('');
          console.log('Production implementation would:');
          console.log('1. Resolve GitHub username to wallet address');
          console.log('2. Mint/transfer tokens on testnet');
          console.log('3. Record transaction hash');
          console.log('4. Issue commemorative NFT badge');
          
          EOF
          
          node distribute_rewards.js
        env:
          CONTRIBUTOR: ${{ needs.evaluate-contribution.outputs.contributor }}
          CONTRIBUTION_TYPE: ${{ needs.evaluate-contribution.outputs.contribution_type }}
          REWARD_AMOUNT: ${{ needs.evaluate-contribution.outputs.reward_amount }}
          REWARDS_WALLET_ADDRESS: ${{ secrets.REWARDS_WALLET_ADDRESS }}
          REWARDS_PRIVATE_KEY: ${{ secrets.REWARDS_PRIVATE_KEY }}
          REWARDS_MINT_ENABLED: ${{ secrets.REWARDS_MINT_ENABLED }}
      
      - name: Post Reward Notification
        uses: actions/github-script@v7
        with:
          script: |
            const contributor = '${{ needs.evaluate-contribution.outputs.contributor }}';
            const contributionType = '${{ needs.evaluate-contribution.outputs.contribution_type }}';
            const rewardAmount = '${{ needs.evaluate-contribution.outputs.reward_amount }}';
            
            const comment = `## ðŸŽ Contribution Reward
            
            Congratulations @${contributor}! Your contribution has been recognized.
            
            **Contribution Type:** ${contributionType.replace(/_/g, ' ')}
            **Reward:** ${rewardAmount} CHX tokens (testnet)
            
            *Note: This is a pilot rewards program using testnet tokens. Production rewards will be distributed on mainnet after full launch.*
            
            To claim your reward:
            1. Ensure your GitHub profile includes your wallet address
            2. Connect to Polygon Mumbai testnet
            3. Tokens will be distributed within 24 hours
            
            Thank you for your valuable contribution to the ScrollVerse ecosystem! ðŸ™
            
            ---
            
            **ALLAHU AKBAR! ðŸ•‹ðŸ”¥ðŸ’ŽðŸŒŒ**`;
            
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            } else if (context.eventName === 'issues') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: comment
              });
            }
      
      - name: Reward Summary
        run: |
          echo "## ðŸŽ Reward Distribution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Contributor:** @${{ needs.evaluate-contribution.outputs.contributor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ needs.evaluate-contribution.outputs.contribution_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Amount:** ${{ needs.evaluate-contribution.outputs.reward_amount }} CHX tokens" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "${{ secrets.REWARDS_WALLET_ADDRESS }}" ]; then
            echo "âš ï¸ **Status:** Not configured (testnet mode)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable rewards, configure these secrets:" >> $GITHUB_STEP_SUMMARY
            echo "- REWARDS_WALLET_ADDRESS" >> $GITHUB_STEP_SUMMARY
            echo "- REWARDS_PRIVATE_KEY" >> $GITHUB_STEP_SUMMARY
            echo "- REWARDS_MINT_ENABLED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status:** Reward queued for distribution" >> $GITHUB_STEP_SUMMARY
          fi
