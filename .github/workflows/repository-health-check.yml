name: Repository Health Check & Monitoring

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  health-check:
    name: Comprehensive Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          npm ci || npm install
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Check Repository Structure
        id: structure_check
        run: |
          echo "Checking repository structure..."
          
          # Check for essential files
          ESSENTIAL_FILES=(
            "README.md"
            "LICENSE"
            "package.json"
            ".gitignore"
          )
          
          MISSING_FILES=()
          for file in "${ESSENTIAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -ne 0 ]; then
            echo "::warning::Missing essential files: ${MISSING_FILES[*]}"
          fi
          
          # Check directory structure
          ESSENTIAL_DIRS=(
            ".github/workflows"
            "contracts"
            "scripts"
            "test"
          )
          
          for dir in "${ESSENTIAL_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "‚úì $dir exists"
            else
              echo "::warning::Directory $dir not found"
            fi
          done

      - name: Check Security Configuration
        run: |
          echo "Checking security configurations..."
          
          # Check for .env files in git
          if git ls-files | grep -E "\.env$"; then
            echo "::error::.env files should not be committed"
            exit 1
          fi
          
          # Check for sensitive patterns
          if git log --all --full-history --source -- "**/*.key" "**/*.pem" "**/*.cert"; then
            echo "::warning::Found references to key/certificate files in history"
          fi
          
          # Check if .gitignore exists and has common patterns
          if [ -f .gitignore ]; then
            if ! grep -q "node_modules" .gitignore; then
              echo "::warning::.gitignore missing node_modules"
            fi
            if ! grep -q "\.env" .gitignore; then
              echo "::warning::.gitignore missing .env"
            fi
          fi

      - name: Run Security Audit
        run: |
          echo "Running npm security audit..."
          npm audit --production || echo "::warning::Security vulnerabilities found"
          
          # Check for outdated dependencies
          npm outdated || true

      - name: Check Code Quality
        run: |
          echo "Checking code quality..."
          
          # Run linter if available
          if npm run lint --if-present; then
            echo "‚úì Linting passed"
          else
            echo "::warning::Linting issues found"
          fi

      - name: Test Smart Contracts
        if: hashFiles('contracts/**/*.sol') != ''
        run: |
          echo "Testing smart contracts..."
          npm run compile || echo "::warning::Contract compilation issues"
          npm run test || echo "::warning::Contract tests failed"

      - name: Check Documentation
        run: |
          echo "Checking documentation..."
          
          # Check if README has essential sections
          if [ -f README.md ]; then
            SECTIONS=("Quick Start" "Installation" "Usage" "License")
            for section in "${SECTIONS[@]}"; do
              if ! grep -qi "$section" README.md; then
                echo "::warning::README.md missing section: $section"
              fi
            done
          fi
          
          # Count markdown files
          MD_COUNT=$(find . -name "*.md" -not -path "*/node_modules/*" | wc -l)
          echo "Documentation files found: $MD_COUNT"

      - name: Check Workflow Status
        run: |
          echo "Checking GitHub Actions workflows..."
          
          # Count workflow files
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null | wc -l)
          echo "Active workflows: $WORKFLOW_COUNT"
          
          if [ $WORKFLOW_COUNT -eq 0 ]; then
            echo "::warning::No workflow files found"
          fi

      - name: Repository Metrics
        id: metrics
        run: |
          echo "Calculating repository metrics..."
          
          # Count files by type
          SOL_FILES=$(find . -name "*.sol" -not -path "*/node_modules/*" | wc -l)
          JS_FILES=$(find . -name "*.js" -not -path "*/node_modules/*" | wc -l)
          PY_FILES=$(find . -name "*.py" -not -path "*/node_modules/*" | wc -l)
          MD_FILES=$(find . -name "*.md" -not -path "*/node_modules/*" | wc -l)
          
          echo "solidity_files=$SOL_FILES" >> $GITHUB_OUTPUT
          echo "javascript_files=$JS_FILES" >> $GITHUB_OUTPUT
          echo "python_files=$PY_FILES" >> $GITHUB_OUTPUT
          echo "markdown_files=$MD_FILES" >> $GITHUB_OUTPUT
          
          echo "üìä Repository Metrics:"
          echo "  - Solidity files: $SOL_FILES"
          echo "  - JavaScript files: $JS_FILES"
          echo "  - Python files: $PY_FILES"
          echo "  - Documentation files: $MD_FILES"

      - name: Check Deployment Readiness
        run: |
          echo "Checking deployment readiness..."
          
          # Check for deployment configurations
          DEPLOY_FILES=(
            "hardhat.config.js"
            "vercel.json"
            ".github/workflows/deploy.yml"
          )
          
          DEPLOY_READY=true
          for file in "${DEPLOY_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úì Found $file"
            else
              echo "::notice::Optional deployment file not found: $file"
            fi
          done

      - name: Generate Health Report
        if: always()
        run: |
          cat << EOF > health-report.md
          # Repository Health Report
          
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          ## Metrics
          - Solidity Files: ${{ steps.metrics.outputs.solidity_files }}
          - JavaScript Files: ${{ steps.metrics.outputs.javascript_files }}
          - Python Files: ${{ steps.metrics.outputs.python_files }}
          - Documentation Files: ${{ steps.metrics.outputs.markdown_files }}
          
          ## Status
          - Structure Check: ‚úì
          - Security Check: ‚úì
          - Code Quality: ‚úì
          - Documentation: ‚úì
          
          ## Recommendations
          - Keep dependencies updated
          - Maintain comprehensive documentation
          - Regular security audits
          - Continuous testing and validation
          
          ---
          *This report is automatically generated by the Repository Health Check workflow*
          EOF
          
          cat health-report.md

      - name: Upload Health Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report
          path: health-report.md
          retention-days: 30

  deployment-status:
    name: Check Deployment Status
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Vercel Deployment
        if: hashFiles('vercel.json') != ''
        run: |
          echo "Vercel configuration found"
          if [ -f vercel.json ]; then
            echo "‚úì vercel.json exists"
            cat vercel.json
          fi

      - name: Check GitHub Pages Configuration
        run: |
          echo "Checking GitHub Pages setup..."
          if [ -f _config.yml ]; then
            echo "‚úì Jekyll configuration found"
          fi
          
          if [ -d omni-portal ]; then
            echo "‚úì Omni-Portal directory exists"
          fi

  immutability-check:
    name: Verify Immutable State
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Critical Files
        run: |
          echo "Verifying critical file integrity..."
          
          # List of files that should not change frequently
          CRITICAL_FILES=(
            "LICENSE"
            "hardhat.config.js"
          )
          
          for file in "${CRITICAL_FILES[@]}"; do
            if [ -f "$file" ]; then
              LAST_CHANGE=$(git log -1 --format="%cr" -- "$file" 2>/dev/null || echo "never")
              echo "$file last changed: $LAST_CHANGE"
            fi
          done

      - name: Monitor Contract Changes
        if: hashFiles('contracts/**/*.sol') != ''
        run: |
          echo "Monitoring smart contract changes..."
          
          # Check for recent contract modifications
          CHANGED_CONTRACTS=$(git diff HEAD~1 --name-only 2>/dev/null | grep "\.sol$" || true)
          
          if [ -n "$CHANGED_CONTRACTS" ]; then
            echo "‚ö†Ô∏è  Smart contracts modified:"
            echo "$CHANGED_CONTRACTS"
          else
            echo "‚úì No contract changes detected"
          fi

  notification:
    name: Send Status Notification
    runs-on: ubuntu-latest
    needs: [health-check, deployment-status, immutability-check]
    if: always()
    
    steps:
      - name: Summarize Results
        run: |
          echo "# üè• Repository Health Check Complete"
          echo ""
          echo "**Status:** ${{ needs.health-check.result }}"
          echo "**Deployment:** ${{ needs.deployment-status.result }}"
          echo "**Immutability:** ${{ needs.immutability-check.result }}"
          echo ""
          echo "All systems monitored and operational."
