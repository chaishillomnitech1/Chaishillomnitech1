name: Code Quality Checks

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci || npm install
      
      - name: Run ESLint
        run: npm run lint || npx eslint . --ext .js,.ts --format json --output-file eslint-report.json || true
        continue-on-error: true
      
      - name: Run Prettier Check
        run: npm run format:check || npx prettier --check "**/*.{js,ts,json,md}" || true
        continue-on-error: true
      
      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO and FIXME comments..."
          grep -r "TODO\|FIXME" --include="*.js" --include="*.ts" --include="*.sol" . || echo "No TODO/FIXME found"
        continue-on-error: true
      
      - name: Check for console.log statements
        run: |
          echo "Checking for console.log statements in production code..."
          grep -r "console\.log" --include="*.js" --include="*.ts" --exclude-dir="test" --exclude-dir="tests" . || echo "No console.log found"
        continue-on-error: true
      
      - name: Analyze bundle size (if applicable)
        run: |
          if [ -f "webpack.config.js" ] || [ -f "next.config.js" ]; then
            echo "Bundle size analysis would run here"
            # Add bundle size analysis tool
          fi
        continue-on-error: true
      
      - name: Check dependencies for vulnerabilities
        run: npm audit --audit-level=moderate || true
        continue-on-error: true
      
      - name: Upload ESLint report
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          if-no-files-found: ignore
        continue-on-error: true

  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install complexity tools
        run: npm install -g complexity-report || true
        continue-on-error: true
      
      - name: Run complexity analysis
        run: |
          echo "Code complexity analysis would run here"
          # cr --format json --output complexity-report.json scripts/**/*.js || true
        continue-on-error: true
      
      - name: Comment complexity on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“Š **Code Quality Check**\n\nâœ… Code quality checks completed. Review the workflow logs for details.'
            });
        continue-on-error: true

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC
        continue-on-error: true
