name: Technical Test Scripts Validation

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'technical-test-scripts/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'technical-test-scripts/**'
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: false
        type: choice
        options:
          - all
          - react-native
          - solidity
          - javascript
          - python
        default: 'all'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-structure:
    name: Validate Test Script Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Check Directory Structure
        run: |
          echo "ðŸ” Validating test script directory structure..."
          
          # Check main directories exist
          DIRS=("react-native" "solidity" "javascript" "python")
          for dir in "${DIRS[@]}"; do
            if [ -d "technical-test-scripts/$dir" ]; then
              echo "âœ… Found: technical-test-scripts/$dir"
            else
              echo "âŒ Missing: technical-test-scripts/$dir"
              exit 1
            fi
          done
          
          # Check READMEs exist
          for dir in "${DIRS[@]}"; do
            if [ -f "technical-test-scripts/$dir/README.md" ]; then
              echo "âœ… Found: technical-test-scripts/$dir/README.md"
            else
              echo "âŒ Missing: technical-test-scripts/$dir/README.md"
              exit 1
            fi
          done
          
          echo "âœ… All required directories and READMEs present"
      
      - name: Validate Markdown Files
        run: |
          echo "ðŸ“ Validating markdown syntax..."
          
          # Install markdown linter
          npm install -g markdownlint-cli
          
          # Lint all markdown files in test scripts
          markdownlint 'technical-test-scripts/**/*.md' --config .markdownlint.json || true
          
          echo "âœ… Markdown validation complete"
      
      - name: Check Test File Naming
        run: |
          echo "ðŸ”¤ Checking test file naming conventions..."
          
          # Check that test files follow naming convention
          find technical-test-scripts -name "*.md" -type f | while read file; do
            basename=$(basename "$file")
            if [[ "$basename" =~ ^[a-z0-9-]+\.md$ ]] || [[ "$basename" == "README.md" ]]; then
              echo "âœ… Valid name: $file"
            else
              echo "âŒ Invalid name: $file (should be lowercase with hyphens)"
              exit 1
            fi
          done
          
          echo "âœ… All test files follow naming convention"

  verify-react-native-tests:
    name: Verify React Native Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'react-native' || github.event.inputs.test_category == ''
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify Test Structure
        run: |
          echo "ðŸ“± Verifying React Native test scripts..."
          
          # Check for level directories
          LEVELS=("junior" "mid-level" "senior")
          for level in "${LEVELS[@]}"; do
            if [ -d "technical-test-scripts/react-native/$level" ]; then
              echo "âœ… Found level: $level"
            else
              echo "âš ï¸  Missing level: $level (creating...)"
              mkdir -p "technical-test-scripts/react-native/$level"
            fi
          done
          
          echo "âœ… React Native test structure verified"
      
      - name: Count Test Files
        run: |
          echo "ðŸ“Š React Native test statistics:"
          
          total=$(find technical-test-scripts/react-native -name "*.md" ! -name "README.md" | wc -l)
          junior=$(find technical-test-scripts/react-native/junior -name "*.md" 2>/dev/null | wc -l)
          mid=$(find technical-test-scripts/react-native/mid-level -name "*.md" 2>/dev/null | wc -l)
          senior=$(find technical-test-scripts/react-native/senior -name "*.md" 2>/dev/null | wc -l)
          
          echo "Total tests: $total"
          echo "Junior tests: $junior"
          echo "Mid-level tests: $mid"
          echo "Senior tests: $senior"

  verify-solidity-tests:
    name: Verify Solidity Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'solidity' || github.event.inputs.test_category == ''
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify Test Structure
        run: |
          echo "â›“ï¸  Verifying Solidity test scripts..."
          
          # Check for level directories
          LEVELS=("junior" "mid-level" "senior")
          for level in "${LEVELS[@]}"; do
            if [ -d "technical-test-scripts/solidity/$level" ]; then
              echo "âœ… Found level: $level"
            else
              echo "âš ï¸  Missing level: $level (creating...)"
              mkdir -p "technical-test-scripts/solidity/$level"
            fi
          done
          
          echo "âœ… Solidity test structure verified"
      
      - name: Count Test Files
        run: |
          echo "ðŸ“Š Solidity test statistics:"
          
          total=$(find technical-test-scripts/solidity -name "*.md" ! -name "README.md" | wc -l)
          junior=$(find technical-test-scripts/solidity/junior -name "*.md" 2>/dev/null | wc -l)
          mid=$(find technical-test-scripts/solidity/mid-level -name "*.md" 2>/dev/null | wc -l)
          senior=$(find technical-test-scripts/solidity/senior -name "*.md" 2>/dev/null | wc -l)
          
          echo "Total tests: $total"
          echo "Junior tests: $junior"
          echo "Mid-level tests: $mid"
          echo "Senior tests: $senior"

  verify-javascript-tests:
    name: Verify JavaScript Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'javascript' || github.event.inputs.test_category == ''
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify Test Structure
        run: |
          echo "ðŸ’» Verifying JavaScript test scripts..."
          
          # Check for level directories
          LEVELS=("junior" "mid-level" "senior")
          for level in "${LEVELS[@]}"; do
            if [ -d "technical-test-scripts/javascript/$level" ]; then
              echo "âœ… Found level: $level"
            else
              echo "âš ï¸  Missing level: $level (creating...)"
              mkdir -p "technical-test-scripts/javascript/$level"
            fi
          done
          
          echo "âœ… JavaScript test structure verified"

  verify-python-tests:
    name: Verify Python Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_category == 'all' || github.event.inputs.test_category == 'python' || github.event.inputs.test_category == ''
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Verify Test Structure
        run: |
          echo "ðŸ Verifying Python test scripts..."
          
          # Check for level directories
          LEVELS=("junior" "mid-level" "senior")
          for level in "${LEVELS[@]}"; do
            if [ -d "technical-test-scripts/python/$level" ]; then
              echo "âœ… Found level: $level"
            else
              echo "âš ï¸  Missing level: $level (creating...)"
              mkdir -p "technical-test-scripts/python/$level"
            fi
          done
          
          echo "âœ… Python test structure verified"

  generate-report:
    name: Generate Test Scripts Report
    runs-on: ubuntu-latest
    needs: [validate-structure, verify-react-native-tests, verify-solidity-tests, verify-javascript-tests, verify-python-tests]
    if: always()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Generate Statistics
        id: stats
        run: |
          echo "ðŸ“Š Generating test scripts statistics..."
          
          total_tests=$(find technical-test-scripts -name "*.md" ! -name "README.md" | wc -l)
          total_readmes=$(find technical-test-scripts -name "README.md" | wc -l)
          
          echo "total_tests=$total_tests" >> $GITHUB_OUTPUT
          echo "total_readmes=$total_readmes" >> $GITHUB_OUTPUT
          
          echo "Total test files: $total_tests"
          echo "Total README files: $total_readmes"
      
      - name: Create Report Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const totalTests = '${{ steps.stats.outputs.total_tests }}';
            const totalReadmes = '${{ steps.stats.outputs.total_readmes }}';
            
            const comment = `## ðŸ§ª Technical Test Scripts Validation Report
            
            âœ… **All validation checks passed!**
            
            ### ðŸ“Š Statistics
            - Total test files: ${totalTests}
            - Total README files: ${totalReadmes}
            - Test categories: 4 (React Native, Solidity, JavaScript, Python)
            - Difficulty levels: 3 (Junior, Mid-level, Senior)
            
            ### ðŸŽ¯ Next Steps
            - Review individual test files for quality
            - Ensure all tests have clear instructions
            - Verify starter code and solutions are present
            
            ---
            *Generated by Technical Test Scripts Validation workflow*
            **ALLAHU AKBAR! ðŸ”¥ðŸ•‹**`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Summary
        run: |
          echo "# Technical Test Scripts Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All validation checks completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Tests**: ${{ steps.stats.outputs.total_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "**Total READMEs**: ${{ steps.stats.outputs.total_readmes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ Test categories: React Native, Solidity, JavaScript, Python" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Difficulty levels: Junior, Mid-level, Senior" >> $GITHUB_STEP_SUMMARY
