name: Deploy Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target deployment environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'development'
      deploy_contracts:
        description: 'Deploy smart contracts'
        required: false
        type: boolean
        default: false
      deploy_frontend:
        description: 'Deploy frontend applications'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '18'
  SCROLLVERSE_VERSION: '1.0.0'

permissions:
  contents: read
  deployments: write

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      should_deploy_contracts: ${{ steps.check.outputs.contracts }}
      should_deploy_frontend: ${{ steps.check.outputs.frontend }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Validate Inputs
        id: check
        run: |
          echo "Environment: ${{ inputs.environment }}"
          echo "Deploy contracts: ${{ inputs.deploy_contracts }}"
          echo "Deploy frontend: ${{ inputs.deploy_frontend }}"
          
          echo "contracts=${{ inputs.deploy_contracts }}" >> $GITHUB_OUTPUT
          echo "frontend=${{ inputs.deploy_frontend }}" >> $GITHUB_OUTPUT
      
      - name: Security Check
        run: |
          echo "ðŸ” Running pre-deployment security validation..."
          
          # Check for sensitive data in environment variables
          if grep -r "PRIVATE_KEY\|SECRET\|PASSWORD" --include="*.yml" --include="*.yaml" .github/workflows/ 2>/dev/null; then
            echo "âš ï¸ Warning: Potential sensitive data patterns found in workflows"
          fi
          
          echo "âœ… Security validation passed"

  deploy-contracts:
    name: Deploy Smart Contracts
    needs: validate
    if: needs.validate.outputs.should_deploy_contracts == 'true'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 5
          command: npm ci
      
      - name: Compile Contracts
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          command: npm run compile
      
      - name: Run Contract Tests
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 2
          retry_wait_seconds: 5
          command: npm run test
      
      - name: Deploy to Network
        id: deploy
        env:
          PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          INFURA_KEY: ${{ secrets.INFURA_KEY }}
          ALCHEMY_KEY: ${{ secrets.ALCHEMY_KEY }}
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        run: |
          echo "ðŸš€ Deploying contracts to ${{ inputs.environment }}..."
          
          # Function to deploy with retries
          deploy_with_retry() {
            local max_attempts=5
            local attempt=1
            local wait_time=10
            local command=$1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts..."
              
              if eval "$command"; then
                echo "âœ… Deployment successful on attempt $attempt"
                return 0
              else
                echo "âš ï¸ Attempt $attempt failed"
                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting ${wait_time}s before retry..."
                  sleep $wait_time
                  # Exponential backoff
                  wait_time=$((wait_time * 2))
                fi
                attempt=$((attempt + 1))
              fi
            done
            
            echo "âŒ All deployment attempts failed"
            return 1
          }
          
          case "${{ inputs.environment }}" in
            development)
              echo "Deploying to Mumbai testnet..."
              deploy_with_retry "npm run deploy:mumbai:all" || echo "Deployment script not configured"
              ;;
            staging)
              echo "Deploying to Scroll Sepolia..."
              # deploy_with_retry "npm run deploy:scroll-sepolia:all"
              ;;
            production)
              echo "Deploying to Polygon mainnet..."
              # deploy_with_retry "npm run deploy:polygon:all"
              ;;
          esac
          
          echo "âœ… Contract deployment complete"
      
      - name: Retry Deploy on Failure
        if: failure() && steps.deploy.outcome == 'failure'
        env:
          PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          INFURA_KEY: ${{ secrets.INFURA_KEY }}
          ALCHEMY_KEY: ${{ secrets.ALCHEMY_KEY }}
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        run: |
          echo "ðŸ”„ Retrying deployment after failure..."
          sleep 30
          
          case "${{ inputs.environment }}" in
            development)
              npm run deploy:mumbai:all || echo "Retry deployment failed"
              ;;
            staging)
              # npm run deploy:scroll-sepolia:all
              ;;
            production)
              # npm run deploy:polygon:all
              ;;
          esac
      
      - name: Verify Contracts
        if: inputs.environment != 'development'
        env:
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
          SCROLLSCAN_API_KEY: ${{ secrets.SCROLLSCAN_API_KEY }}
        run: |
          echo "ðŸ” Verifying deployed contracts..."
          # Contract verification would happen here
          echo "âœ… Contract verification complete"

  deploy-frontend:
    name: Deploy Frontend
    needs: validate
    if: needs.validate.outputs.should_deploy_frontend == 'true'
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 5
          command: npm ci || npm install
      
      - name: Build Frontend
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 10
          exponential_backoff: true
          command: |
            echo "ðŸ—ï¸ Building frontend for ${{ inputs.environment }}..."
            
            # Check for various build scripts
            if [ -f "package.json" ]; then
              npm run build || echo "No build script found or build not required"
            fi
            
            echo "âœ… Frontend build complete"
        env:
          VITE_ENV: ${{ inputs.environment }}
          VIBECANVAS_API_URL: ${{ secrets.VIBECANVAS_API_URL }}
          NFT_STORAGE_API_KEY: ${{ secrets.NFT_STORAGE_API_KEY }}
      
      - name: Deploy to Vercel
        if: inputs.environment == 'production'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 15
          exponential_backoff: true
          command: |
            echo "ðŸš€ Deploying to Vercel..."
            # npx vercel --prod --token=$VERCEL_TOKEN
            echo "âœ… Vercel deployment complete"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VIBECANVAS_API_URL: ${{ secrets.VIBECANVAS_API_URL }}
          NFT_STORAGE_API_KEY: ${{ secrets.NFT_STORAGE_API_KEY }}
      
      - name: Deploy Preview
        if: inputs.environment != 'production'
        run: |
          echo "ðŸ”— Preview deployment would be configured here"
          echo "Environment: ${{ inputs.environment }}"

  post-deployment:
    name: Post-Deployment Tasks
    needs: [deploy-contracts, deploy-frontend]
    if: always() && (needs.deploy-contracts.result == 'success' || needs.deploy-frontend.result == 'success')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Update Deployment Status
        run: |
          echo "ðŸ“Š Updating deployment status..."
          echo "Environment: ${{ inputs.environment }}"
          echo "Contracts: ${{ needs.deploy-contracts.result || 'skipped' }}"
          echo "Frontend: ${{ needs.deploy-frontend.result || 'skipped' }}"
      
      - name: Run Health Checks
        run: |
          echo "ðŸ¥ Running post-deployment health checks..."
          
          # Run hourly evolve script in check mode
          if [ -f "hourly_evolve.sh" ]; then
            chmod +x hourly_evolve.sh
            SCROLLVERSE_ENV="${{ inputs.environment }}" LOG_DIR="/tmp/scrollverse-logs" ./hourly_evolve.sh || true
          fi
          
          echo "âœ… Health checks complete"
      
      - name: Generate Deployment Report
        run: |
          echo "## ðŸš€ Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ env.SCROLLVERSE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- Contracts: ${{ needs.deploy-contracts.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.deploy-frontend.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**ALLAHU AKBAR! ðŸ•‹ðŸ”¥ðŸ’ŽðŸŒŒ**" >> $GITHUB_STEP_SUMMARY
