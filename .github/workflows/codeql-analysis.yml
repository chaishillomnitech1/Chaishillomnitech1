# ============================================================================
# CodeQL Analysis Workflow - ScrollVerse Security Scanning
# ============================================================================
#
# Advanced security analysis using GitHub CodeQL
# Scans for vulnerabilities in JavaScript, TypeScript, and Solidity code
#
# @author ScrollVerse Security Team
# @version 1.0.0
# ============================================================================

name: CodeQL Analysis

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  schedule:
    # Run weekly on Sundays at 3:00 AM UTC
    - cron: '0 3 * * 0'

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  # ============================================================================
  # CodeQL Analysis
  # ============================================================================
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        language:
          - javascript-typescript
          - actions

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # ============================================================================
  # Dependency Review (for Pull Requests)
  # ============================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  # ============================================================================
  # Smart Contract Security (Solidity specific)
  # ============================================================================
  solidity-security:
    name: Solidity Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci || npm install

      - name: Basic Solidity Pattern Checks
        run: |
          echo "ðŸ” Running basic Solidity pattern checks..."
          echo ""
          echo "âš ï¸  DISCLAIMER: These are simple heuristic checks, not comprehensive security audits."
          echo "    For production deployments, use professional tools like:"
          echo "    - Slither (https://github.com/crytic/slither)"
          echo "    - Mythril (https://github.com/ConsenSys/mythril)"
          echo "    - Securify (https://securify.chainsecurity.com/)"
          echo "    - Professional audit services"
          echo ""
          
          # Check for reentrancy patterns
          echo "Checking for reentrancy patterns..."
          if grep -rn "call{value" contracts/ 2>/dev/null | grep -v "ReentrancyGuard"; then
            echo "â„¹ï¸ External calls with value found - verify ReentrancyGuard is used"
          else
            echo "âœ… No obvious reentrancy patterns detected"
          fi
          
          # Check for unchecked external calls
          echo "Checking for unchecked external calls..."
          if grep -rn "\.call(" contracts/ 2>/dev/null | grep -v "require\|assert\|if.*success"; then
            echo "â„¹ï¸ External calls found - verify return values are properly handled"
          else
            echo "âœ… External call patterns look safe"
          fi
          
          # Check for tx.origin usage
          echo "Checking for tx.origin usage..."
          if grep -rn "tx.origin" contracts/ 2>/dev/null; then
            echo "âš ï¸ tx.origin usage detected - potential phishing vulnerability"
          else
            echo "âœ… No tx.origin usage detected"
          fi
          
          # Check for timestamp dependency
          echo "Checking for timestamp dependency..."
          if grep -rn "block.timestamp" contracts/ 2>/dev/null | grep -v "comment\|//"; then
            echo "â„¹ï¸ block.timestamp usage detected - verify it's not used for critical randomness"
          fi
          
          echo ""
          echo "âœ… Basic pattern checks complete"
          echo "âš ï¸  Remember: These checks have limitations and may produce false positives/negatives"

      - name: Generate Security Report
        run: |
          echo "## ðŸ” Solidity Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Basic Pattern Checks Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **âš ï¸ IMPORTANT**: These are basic heuristic checks only. They may produce false positives and can miss real vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Basic Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "- Reentrancy vulnerability patterns (limited - doesn't check inheritance)" >> $GITHUB_STEP_SUMMARY
          echo "- Unchecked external calls (basic grep - may miss if-statement checks)" >> $GITHUB_STEP_SUMMARY
          echo "- tx.origin usage" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp dependency (flags all usage, even safe cases)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommended for Production" >> $GITHUB_STEP_SUMMARY
          echo "For comprehensive security analysis, use professional tools:" >> $GITHUB_STEP_SUMMARY
          echo "- **[Slither](https://github.com/crytic/slither)** - Static analysis framework" >> $GITHUB_STEP_SUMMARY
          echo "- **[Mythril](https://github.com/ConsenSys/mythril)** - Security analysis tool" >> $GITHUB_STEP_SUMMARY
          echo "- **[Securify](https://securify.chainsecurity.com/)** - Automated security scanner" >> $GITHUB_STEP_SUMMARY
          echo "- **Professional audit services** - For production deployments" >> $GITHUB_STEP_SUMMARY
